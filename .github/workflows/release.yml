name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libssl-dev g++

      - name: Download dependencies
        run: |
          mkdir -p external/CLI11
          curl -sL -o external/simdjson.h https://github.com/simdjson/simdjson/releases/download/v3.11.6/simdjson.h
          curl -sL -o external/simdjson.cpp https://github.com/simdjson/simdjson/releases/download/v3.11.6/simdjson.cpp
          curl -sL https://github.com/CLIUtils/CLI11/archive/refs/tags/v2.4.2.tar.gz | tar xz -C external
          mv external/CLI11-2.4.2/include/CLI external/CLI11/CLI
          rm -rf external/CLI11-2.4.2
          curl -sL -o external/httplib.h https://raw.githubusercontent.com/yhirose/cpp-httplib/v0.18.3/httplib.h

      - name: Build
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel $(nproc)
          strip build/ascii-weather-tui

      - name: Package
        run: |
          mkdir -p release
          cp build/ascii-weather-tui release/
          cd release
          tar -czf ascii-weather-tui-linux-x64.tar.gz ascii-weather-tui

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: release/ascii-weather-tui-linux-x64.tar.gz

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install cmake ninja openssl

      - name: Download dependencies
        run: |
          mkdir -p external/CLI11
          curl -sL -o external/simdjson.h https://github.com/simdjson/simdjson/releases/download/v3.11.6/simdjson.h
          curl -sL -o external/simdjson.cpp https://github.com/simdjson/simdjson/releases/download/v3.11.6/simdjson.cpp
          curl -sL https://github.com/CLIUtils/CLI11/archive/refs/tags/v2.4.2.tar.gz | tar xz -C external
          mv external/CLI11-2.4.2/include/CLI external/CLI11/CLI
          rm -rf external/CLI11-2.4.2
          curl -sL -o external/httplib.h https://raw.githubusercontent.com/yhirose/cpp-httplib/v0.18.3/httplib.h

      - name: Build
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl)
          cmake --build build --parallel $(sysctl -n hw.ncpu)
          strip build/ascii-weather-tui

      - name: Package
        run: |
          mkdir -p release
          cp build/ascii-weather-tui release/
          cd release
          tar -czf ascii-weather-tui-macos-$(uname -m).tar.gz ascii-weather-tui

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: release/ascii-weather-tui-macos-*.tar.gz

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install OpenSSL
        run: choco install openssl -y

      - name: Download dependencies
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path external/CLI11
          
          Write-Host "Downloading simdjson..."
          Invoke-WebRequest -Uri "https://github.com/simdjson/simdjson/releases/download/v3.11.6/simdjson.h" -OutFile "external/simdjson.h"
          Invoke-WebRequest -Uri "https://github.com/simdjson/simdjson/releases/download/v3.11.6/simdjson.cpp" -OutFile "external/simdjson.cpp"
          
          Write-Host "Downloading CLI11..."
          Invoke-WebRequest -Uri "https://github.com/CLIUtils/CLI11/archive/refs/tags/v2.4.2.tar.gz" -OutFile "cli11.tar.gz"
          tar -xzf cli11.tar.gz -C external
          Move-Item -Path external/CLI11-2.4.2/include/CLI -Destination external/CLI11/CLI
          Remove-Item -Recurse -Force external/CLI11-2.4.2
          Remove-Item cli11.tar.gz
          
          Write-Host "Downloading cpp-httplib..."
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/yhirose/cpp-httplib/v0.18.3/httplib.h" -OutFile "external/httplib.h"

      - name: Build
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DOPENSSL_ROOT_DIR="C:/Program Files/OpenSSL-Win64"
          cmake --build build --config Release --parallel

      - name: Package
        run: |
          mkdir release
          copy build\Release\ascii-weather-tui.exe release\
          cd release
          Compress-Archive -Path ascii-weather-tui.exe -DestinationPath ascii-weather-tui-windows-x64.zip

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: release/ascii-weather-tui-windows-x64.zip

  release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/linux-x64/ascii-weather-tui-linux-x64.tar.gz
            artifacts/macos/ascii-weather-tui-macos-*.tar.gz
            artifacts/windows-x64/ascii-weather-tui-windows-x64.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
